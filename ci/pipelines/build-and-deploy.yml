groups:
- name: self-update
  jobs:
  - self-update
- name: deployer
  jobs:
  - deploy
- name: pr
  jobs:
    - build

resource_types:
- name: pull-request
  type: registry-image
  source:
    repository: teliaoss/github-pr-resource
    username: ((docker_hub_username))
    password: ((docker_hub_authtoken))

resources:
  - name: govwifi-product-page
    type: git
    source:
      uri: "https://github.com/alphagov/govwifi-product-page.git"

  - name: govwifi-product-page-pr
    type: pull-request
    source:
      repository: alphagov/govwifi-product-page
      access_token: ((github-access-token))
      disable_forks: true

  - name: organisations-list
    type: s3
    source:
      bucket: govwifi-production-product-page-data
      versioned_file: organisations.yml
      region_name: eu-west-2

  - name: whitelisted-emails
    type: s3
    source:
      bucket: govwifi-production-product-page-data
      versioned_file: domains.yml
      region_name: eu-west-2

  - name: deploy-to-paas
    # See https://github.com/alphagov/tech-ops/blob/master/reliability-engineering/pipelines/internal-apps.yml
    type: cf
    source:
      api: "https://api.cloud.service.gov.uk"
      organization: "govwifi"
      space: "production"
      username: ((govpaas-username))
      password: ((govpaas-password))

jobs:
  - name: self-update
    serial: true
    plan:
    - get: govwifi-product-page
      trigger: true
    - set_pipeline: product-page-deploy
      file: govwifi-product-page/ci/pipelines/build-and-deploy.yml

  - name: build
    interruptible: true
    disable_manual_trigger: true
    serial: true
    plan:
      - get: govwifi-product-page-pr
        trigger: true
        version: every
      - put: govwifi-product-page-pr
        params:
          status: pending
          path: govwifi-product-page-pr
      - task: bundle-govwifi-product-page-pr
        timeout: 15m
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: governmentpaas/cf-cli
              username: ((docker_hub_username))
              password: ((docker_hub_authtoken))
            version: {digest: "sha256:524554e6bcd9e77e9f3886de0ee2c1307976361a41a009b4690c709afd52812e"}
          inputs:
            - name: govwifi-product-page-pr
              path: repo
          run:
            path: sh
            dir: repo
            args:
            - -eu
            - -c
            - |
              apk --update add g++ musl-dev make nodejs nodejs-npm
              npm install --unsafe-perm
              bundle install --without development
              bundle exec middleman build
    on_success:
      put: govwifi-product-page-pr
      params:
        path: govwifi-product-page-pr
        status: success
    on_failure:
      put: govwifi-product-page-pr
      params:
        path: govwifi-product-page-pr
        status: failure
  - name: deploy
    serial: true
    plan:
      - get: govwifi-product-page
        passed: [self-update]
        trigger: true
      - get: organisations-list
        trigger: true
      - get: whitelisted-emails
        trigger: true
      - task: bundle-govwifi-product-page
        timeout: 15m
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: governmentpaas/cf-cli
              username: ((docker_hub_username))
              password: ((docker_hub_authtoken))
            version: {digest: "sha256:524554e6bcd9e77e9f3886de0ee2c1307976361a41a009b4690c709afd52812e"}
          inputs:
            - name: govwifi-product-page
              path: repo
            - name: whitelisted-emails
            - name: organisations-list
          outputs:
            - name: build
          run:
            path: sh
            dir: repo
            args:
            - -eu
            - -c
            - |
              apk --update add g++ musl-dev make nodejs nodejs-npm
              npm install --unsafe-perm
              bundle install --without development
              cp ../whitelisted-emails/domains.yml data/domains.yml
              cp ../organisations-list/organisations.yml data/organisations.yml
              bundle exec middleman build
              cp -r build/* ../build
              cp manifest.yml ../build
      - put: deploy-to-paas
        params:
          current_app_name: govwifi-product-page
          manifest: build/manifest.yml
          show_app_log: true
          path: build
